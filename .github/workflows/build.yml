name: Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    name: Build C# Executables
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/v(.+)') {
            $version = $matches[1]
          } else {
            $version = "0.0.0-dev"
          }

          Write-Host "Version: $version" -ForegroundColor Cyan
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Update Directory.Build.props version
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $propsFile = ".\src\csharp\Directory.Build.props"

          Write-Host "Updating Directory.Build.props with version: $version" -ForegroundColor Cyan

          $content = Get-Content $propsFile -Raw
          $content = $content -replace '<Version>[^<]+</Version>', "<Version>$version</Version>"
          $content = $content -replace '<AssemblyVersion>[^<]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
          $content = $content -replace '<FileVersion>[^<]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
          $content = $content -replace '<InformationalVersion>[^<]+</InformationalVersion>', "<InformationalVersion>$version</InformationalVersion>"

          Set-Content $propsFile -Value $content -NoNewline

          Write-Host "Updated Directory.Build.props:" -ForegroundColor Green
          Get-Content $propsFile

      - name: Restore dependencies
        run: dotnet restore src/csharp/Naner.sln

      - name: Build naner.exe
        shell: pwsh
        run: |
          Write-Host "Building naner.exe..." -ForegroundColor Cyan
          dotnet publish src/csharp/Naner.Launcher/Naner.Launcher.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ./dist/bin

      - name: Build naner-init.exe
        shell: pwsh
        run: |
          Write-Host "Building naner-init.exe..." -ForegroundColor Cyan
          dotnet publish src/csharp/Naner.Init/Naner.Init.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ./dist/bin

      - name: Create distribution package
        shell: pwsh
        run: |
          Write-Host "Creating distribution package..." -ForegroundColor Cyan

          $distDir = ".\dist\naner-portable"
          New-Item -Path $distDir -ItemType Directory -Force | Out-Null

          # Copy executables
          Copy-Item -Path ".\dist\bin\naner.exe" -Destination "$distDir\" -Force
          Copy-Item -Path ".\dist\bin\naner-init.exe" -Destination "$distDir\" -Force
          Copy-Item -Path ".\dist\bin\.naner-version" -Destination "$distDir\" -Force

          # Copy config files
          if (Test-Path ".\config") {
            Copy-Item -Path ".\config" -Destination "$distDir\config" -Recurse -Force
          }

          # Copy documentation
          if (Test-Path ".\README.md") {
            Copy-Item -Path ".\README.md" -Destination "$distDir\" -Force
          }

          # List contents
          Write-Host "Distribution contents:" -ForegroundColor Gray
          Get-ChildItem -Path $distDir -Recurse | ForEach-Object {
            $relativePath = $_.FullName.Replace((Get-Item $distDir).FullName, "")
            Write-Host "  $relativePath" -ForegroundColor Gray
          }

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Write-Host "Creating ZIP archive..." -ForegroundColor Cyan

          $version = "${{ steps.get_version.outputs.version }}"
          $zipName = "naner-portable-$version.zip"

          Compress-Archive -Path ".\dist\naner-portable\*" -DestinationPath ".\dist\$zipName" -Force
          Write-Host "Created: $zipName" -ForegroundColor Green

          $size = [math]::Round((Get-Item ".\dist\$zipName").Length / 1MB, 2)
          Write-Host "Size: $size MB" -ForegroundColor Gray

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: naner-portable-${{ steps.get_version.outputs.version }}
          path: dist/*.zip
          retention-days: 90

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.zip
            dist/bin/naner.exe
            dist/bin/naner-init.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-build:
    name: Validate Build Artifacts
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: naner-portable-*
          path: artifacts

      - name: Validate ZIP structure
        shell: pwsh
        run: |
          Write-Host "Validating build artifacts..." -ForegroundColor Cyan

          $zipFiles = Get-ChildItem -Path .\artifacts -Filter *.zip -Recurse

          if ($zipFiles.Count -eq 0) {
            Write-Host "No ZIP files found" -ForegroundColor Red
            exit 1
          }

          foreach ($zip in $zipFiles) {
            Write-Host "Validating: $($zip.Name)" -ForegroundColor Gray

            $tempExtract = Join-Path ([System.IO.Path]::GetTempPath()) "naner_validate_$([Guid]::NewGuid())"
            Expand-Archive -Path $zip.FullName -DestinationPath $tempExtract

            # Check for required files
            $requiredItems = @(
              "naner.exe",
              "naner-init.exe",
              ".naner-version",
              "config\vendors.json"
            )

            $missing = @()
            foreach ($item in $requiredItems) {
              $fullPath = Join-Path $tempExtract $item
              if (-not (Test-Path $fullPath)) {
                $missing += $item
              }
            }

            if ($missing.Count -gt 0) {
              Write-Host "  [X] Missing required files:" -ForegroundColor Red
              $missing | ForEach-Object { Write-Host "    $_" -ForegroundColor Red }
              Remove-Item $tempExtract -Recurse -Force
              exit 1
            } else {
              Write-Host "  [OK] All required files present" -ForegroundColor Green
            }

            # Verify executables are valid PE files
            $nanerExe = Join-Path $tempExtract "naner.exe"
            $initExe = Join-Path $tempExtract "naner-init.exe"

            $nanerSize = [math]::Round((Get-Item $nanerExe).Length / 1MB, 2)
            $initSize = [math]::Round((Get-Item $initExe).Length / 1MB, 2)

            Write-Host "  naner.exe: $nanerSize MB" -ForegroundColor Gray
            Write-Host "  naner-init.exe: $initSize MB" -ForegroundColor Gray

            # Check version file content
            $versionContent = Get-Content (Join-Path $tempExtract ".naner-version") -Raw
            Write-Host "  Version: $($versionContent.Trim())" -ForegroundColor Gray

            Remove-Item $tempExtract -Recurse -Force
          }

          Write-Host ""
          Write-Host "All build artifacts validated successfully" -ForegroundColor Green
