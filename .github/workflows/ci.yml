name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    uses: ./.github/workflows/test.yml
    permissions:
      contents: read

  build:
    uses: ./.github/workflows/build.yml
    needs: test
    permissions:
      contents: write

  documentation-check:
    name: Documentation Check
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check documentation completeness
        shell: pwsh
        run: |
          Write-Host "Checking documentation completeness..." -ForegroundColor Cyan

          $requiredDocs = @(
            "README.md",
            "docs/ARCHITECTURE.md"
          )

          $missing = @()

          foreach ($doc in $requiredDocs) {
            if (Test-Path $doc) {
              $size = (Get-Item $doc).Length
              Write-Host "  [OK] $doc ($size bytes)" -ForegroundColor Green
            } else {
              Write-Host "  [X] Missing: $doc" -ForegroundColor Yellow
              $missing += $doc
            }
          }

          if ($missing.Count -gt 0) {
            Write-Host ""
            Write-Host "Missing documentation files (warning only):" -ForegroundColor Yellow
          }

          Write-Host ""
          Write-Host "Documentation check complete" -ForegroundColor Green

  security-check:
    name: Security Scan
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for sensitive data
        shell: pwsh
        run: |
          Write-Host "Scanning for potentially sensitive data..." -ForegroundColor Cyan

          $patterns = @(
            @{Name = "API Keys"; Pattern = '(?i)(api[_-]?key|apikey)\s*[:=]\s*[''"]?[a-zA-Z0-9]{20,}'},
            @{Name = "Tokens"; Pattern = '(?i)(token|auth|secret)\s*[:=]\s*[''"]?[a-zA-Z0-9]{20,}'},
            @{Name = "Passwords"; Pattern = '(?i)(password|passwd|pwd)\s*[:=]\s*[''"]?[^\s''",]{8,}'},
            @{Name = "Private Keys"; Pattern = '-----BEGIN (RSA |DSA |EC )?PRIVATE KEY-----'}
          )

          $findings = @()

          $files = Get-ChildItem -Path . -Recurse -File |
            Where-Object { $_.Extension -match '\.(cs|json|md|txt|yml|yaml|xml|csproj|props)$' } |
            Where-Object { $_.FullName -notmatch '(node_modules|\.git|vendor|bin|obj)' }

          foreach ($file in $files) {
            $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue

            if ($content) {
              foreach ($pattern in $patterns) {
                if ($content -match $pattern.Pattern) {
                  $findings += @{
                    File = $file.FullName
                    Type = $pattern.Name
                  }
                }
              }
            }
          }

          if ($findings.Count -gt 0) {
            Write-Host "Found $($findings.Count) potential sensitive data occurrence(s):" -ForegroundColor Yellow
            $findings | ForEach-Object {
              Write-Host "  $($_.Type) in $($_.File)" -ForegroundColor Gray
            }
            Write-Host ""
            Write-Host "Please review these files to ensure no actual secrets are committed" -ForegroundColor Yellow
          } else {
            Write-Host "No sensitive patterns detected" -ForegroundColor Green
          }
