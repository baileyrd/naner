name: Tests

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-check:
    name: Build Check
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore src/csharp/Naner.sln

      - name: Build solution
        run: dotnet build src/csharp/Naner.sln -c Release --no-restore

      - name: Validate configuration files
        shell: pwsh
        run: |
          Write-Host "Validating JSON configuration files..." -ForegroundColor Cyan

          $configFiles = @(
            ".\config\naner.json",
            ".\config\vendors.json",
            ".\config\vendors-schema.json"
          )

          foreach ($file in $configFiles) {
            Write-Host "Validating: $file" -ForegroundColor Gray

            try {
              $content = Get-Content $file -Raw
              $json = $content | ConvertFrom-Json
              Write-Host "  [OK] Valid JSON" -ForegroundColor Green
            } catch {
              Write-Host "  [X] Invalid JSON: $_" -ForegroundColor Red
              exit 1
            }
          }

          Write-Host ""
          Write-Host "All configuration files are valid" -ForegroundColor Green

      - name: Check for required directories
        shell: pwsh
        run: |
          Write-Host "Checking required directories..." -ForegroundColor Cyan

          $requiredDirs = @(
            ".\config",
            ".\docs",
            ".\src\csharp",
            ".\vendor"
          )

          $missing = @()

          foreach ($dir in $requiredDirs) {
            if (Test-Path $dir) {
              Write-Host "  [OK] $dir" -ForegroundColor Green
            } else {
              Write-Host "  [X] Missing: $dir" -ForegroundColor Red
              $missing += $dir
            }
          }

          if ($missing.Count -gt 0) {
            Write-Host ""
            Write-Host "Missing required directories:" -ForegroundColor Red
            $missing | ForEach-Object { Write-Host "  $_" -ForegroundColor Red }
            exit 1
          }

          Write-Host ""
          Write-Host "All required directories present" -ForegroundColor Green
